<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="_csrf" th:content="${_csrf != null} ? ${_csrf.token} : ''" />
	<meta name="_csrf_header" th:content="${_csrf != null}? ${_csrf.headerName} : 'X-CSRF-TOKEN'" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title th:utext="#{index.page.title}">Home</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../static/css/custom.css" th:href="@{/resources/css/custom.css}" />
	<link rel="icon" href="../static/favicon.ico" th:href="@{/resources/favicon.ico}" type="image/x-icon" />
	<!-- DataTables styles -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.4.0/css/select.dataTables.min.css">
</head>
<body th:dir="#{dir}" th:lang="en" dir="ltr" lang="en" th:data-master-url="@{/coins/data}" data-master-url="../static/offline/coinsdata.json" th:data-details-url="@{/coins/}" data-details-url="../static/offline/$DUMMY.json">
	<div class="container">
		<div class="header clearfix">
			<nav th:replace="fragments/navbar :: navbar('index')">
				<ul class="nav nav-pills pull-right">
					<li role="presentation" class="active"><a href="index.html">Home</a></li>
					<li role="presentation"><a href="about.html">About</a></li>
					<li role="presentation"><a href="contact.html">Contact</a></li>
				</ul>
			</nav>
			<h3 th:utext="#{nav.menu.brand}" class="text-muted">Crypto Currency Proxy</h3>
		</div>

		<div class="jumbotron">
			<h1 th:utext="#{index.page.heading}">Welcome</h1>
			<p  th:utext="#{index.page.lead}" class="lead">Use the search box to filter crypto-currencies of interest. You can smart search for symbols or algorithms. Search is case-insensitive. Wrap the search in double quotes and/or spaces (e.g. &quot;BTC&quot;) for an exact match. You can also a select crypto-currency row, to view the full details in the panel on the right. Use the 'Refresh' button to retrieve a fresh list of crypto-currencies.</p>
			<p><a id="refresh-btn" th:utext="#{index.page.heading.btn}" class="btn btn-lg btn-success" href="#" role="button">Refresh</a></p>
		</div>

		<div class="row marketing">
			<div class="col-md-8">
				<h4 th:utext="#{index.page.datatable.header}">Available Currencies</h4>
				<table id="datatable" class="display" style="width:100%">
					<thead>
						<tr>
						    <th th:utext="#{datatable.th.name}">Name</th>
						    <th th:utext="#{datatable.th.symbol}">Symbol</th>
							<th th:utext="#{datatable.th.algorithm}">Algorithm</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="col-md-4">
				<div id="details-group" class="panel-group" style="border: 1px">
					<div id="details-panel" class="panel panel-default" >
						<div class="panel-heading">
							<h4 id="details-message" th:data-loading-msg="#{index.page.details.loading}" data-loading-msg="Loading..." th:data-default-msg="#{index.page.details.default}" data-default-msg="Crypto Currency Details" th:data-error-msg="#{index.page.details.error}" data-error-msg="No {0} Details Available" th:data-success-msg="#{index.page.details.success}" data-success-msg="{0} Currency Details"  class="panel-title" th:utext="#{index.page.details.default}">Crypto Currency Details</h4>
						</div>
						<div class="panel-body">
							<span th:utext="#{index.page.details.id}">Id:</span>
							<span>&nbsp;</span>
							<span id="ccIdSpan">&nbsp;</span>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-body">
							<span th:utext="#{index.page.details.name}">Name:</span>
							<span>&nbsp;</span>
							<span id="ccNameSpan">&nbsp;</span>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-body">
							<span th:utext="#{index.page.details.symbol}">Symbol:</span>
							<span>&nbsp;</span>
							<span id="ccSymbolSpan">&nbsp;</span>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-body">
							<span th:utext="#{index.page.details.algo}">Algorithm:</span>
							<span>&nbsp;</span>
							<span id="ccAlgoSpan">&nbsp;</span>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-body">
							<span th:utext="#{index.page.details.usd}">USD Rate:</span>
							<span>&nbsp;</span>
							<span id="ccUSDSpan">&nbsp;</span>
						</div>
					</div>
				</div>
			</div>
		</div>

        <footer id="footer" class="footer">
        	<p th:utext="'&copy;' + '&nbsp;' + ${#dates.year(#dates.createNow())} + '&nbsp;' + #{footer.copy}">&copy; 2022 Crypto-Proxy, Inc.</p>
        </footer>
	</div>

	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->
	<!-- DataTables -->
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/1.4.0/js/dataTables.select.min.js"></script>
    <!-- custom index page js library (can replace the script bellow) -->
    <!-- <script src="../static/js/index.js" th:src="@{/resources/js/index.js}"></script> -->

    <script type="text/javascript">

        var loadingMsg = $('#details-message').attr('data-loading-msg');
	    var errorMsg = $('#details-message').attr('data-error-msg');
	    var successMsg = $('#details-message').attr('data-success-msg');
	    var defaultMsg = $('#details-message').attr('data-default-msg');

	    /**
	     * extract the currency symbol from the datatable
	     * row and build an ajax url to retrieve details.
	     */
	    function getDetailsUrl(row) {
	    	var url = $('body').attr('data-details-url');
	    	var symbol = row.data().symbol;
	    	if (url.indexOf('$DUMMY') > -1)
	    		url = url.replace('$DUMMY', symbol);
	    	else
	    		url += symbol;
	    	console.debug("getDetailsUrl(row) -> url:", url);
	    	return url;
	    }

	    function getDetails(url) {
	    	$.ajax({
	    		type: "GET",
	    		url: url,
	    		beforeSend: function(jqXHR, settings) {
	               $('#details-message').text(loadingMsg);
	    		   if (!$('#details-panel').hasClass('panel-warning'))
	    				$('#details-panel').addClass('panel-warning');
	    		},
	    		statusCode: {
	    			200: function(data, status, jqXHR) {
	    			    console.debug("getDetails(url) -> message: ", data.message,", id:", data.data[0].id, ", coinName:", data.data[0].coinName,", symbol: ", data.data[0].symbol, ", algorithm: ", data.data[0].algorithm, ", toUSD:", data.data[0].toUSD);
	    			    renderDetails(data, false);
	    			}
	    		},
	    		error: function( jqXHR, status, error ) {
	    			var symbol = (url.substring(url.lastIndexOf("/") + 1)).replace(".json","");
	    			console.debug("getDetails(url) -> symbol:", symbol ,", status:", status);
	    			renderDetails({"symbol": symbol}, true);
	    		}
	    	});
	    }

	    function renderDetails(data, isError) {

	    	if ($('#details-panel').hasClass('panel-warning'))
	    		$('#details-panel').removeClass('panel-warning');
	        if ($('#details-panel').hasClass('panel-default'))
	        	$('#details-panel').removeClass('panel-default');

	    	if (!isError && null != data && data.data) {
	    	    //var message = data.message;
	    		var json = data.data[0];
	    		$("#ccIdSpan").text(json.id ? json.id : "N/A");
	    		$("#ccNameSpan").text(json.coinName ? json.coinName : "N/A");
	    		$("#ccSymbolSpan").text(json.symbol ? json.symbol : "N/A");
	    		$("#ccAlgoSpan").text(json.algorithm ? json.algorithm : "N/A");
	    		$("#ccUSDSpan").text(json.toUSD ? json.toUSD : "N/A");
	    	}

	    	if (isError) {
	    		var msg = data && data.symbol ? errorMsg.replace("{0}", data.symbol) : errorMsg;
				$('#details-message').text(msg);
				if (!$('#details-panel').hasClass('panel-danger'))
					$('#details-panel').addClass('panel-danger');
	    	} else {
	            $('#details-message').text(successMsg.replace("{0}", data.data[0].symbol));
				if (!$('#details-panel').hasClass('panel-primary'))
					$('#details-panel').addClass('panel-primary');
	    	}
	    }

	    function clearDetails() {
	    	$("#ccIdSpan").empty();
	    	$("#ccNameSpan").empty();
	    	$("#ccSymbolSpan").empty();
	    	$("#ccAlgoSpan").empty();
	    	$("#ccUSDSpan").empty();
	    	if ($('#details-panel').hasClass('panel-warning'))
	            $('#details-panel').removeClass('panel-warning');
	    	if ($('#details-panel').hasClass('panel-primary'))
	            $('#details-panel').removeClass('panel-primary');
	    	if ($('#details-panel').hasClass('panel-danger'))
	            $('#details-panel').removeClass('panel-danger');
	        if (!$('#details-panel').hasClass('panel-default'))
	            $('#details-panel').addClass('panel-default');
	        $('#details-message').text(defaultMsg);
	    }

       /**
        * initialize the datatable and create handlers
        * for selection of a row and for retrieving the
        * currency details.
        */
	    $(document).ready(function () {

	        var masterUrl = $('body').attr('data-master-url');
	    	var table = $('#datatable').DataTable({
	    		ajax: { url: masterUrl, async: true },
	    		columns: [ { "data": "coinName", "searchable": false}, { "data": "symbol" }, { "data": "algorithm" } ],
	    		order: [ [1, "asc"], [2, "asc"] ],
	    		//columns: [ { "data": "symbol" }, { "data": "algorithm" } ],
	    		//order: [ [0, "asc"], [1, "asc"] ],
	    		lengthMenu: [ [-1,4000,2000,1000,500,250,50], ["All",4000,2000,1000,500,250,50] ],
	    		paging: true,
	    		scrollY: "300px",
	    		scrollCollapse: true,
	    		autoWidth: false,
	    		deferRender: true,
	    		select: true
	    	});

	       /**
	        * make sure only onerow can be selected, extract
	        * the symbol from the selected row and ajax to
	        * the API url to retrieve the currency details.
	        */
	       table.on( 'click', 'tbody tr', function () {
	    	    clearDetails();
	    	    if ($(this).hasClass('selected')) {
	                table.$('tr.selected').removeClass('selected');
	            } else {
	            	table.$('tr.selected').removeClass('selected');
	                $(this).addClass('selected');
	                var row = $('#datatable').DataTable().row(this);
	                var url = getDetailsUrl(row);
	    			getDetails(url);
	            }
	       });

	       /**
	        * attach on-click handler to the 'refresh' button.
	        */
	       $('#refresh-btn').click(function (e){
	    	   e.preventDefault();
	    	   clearDetails();
	    	   table.clear();
	    	   table.ajax.reload(null, true);
	    	   table.order([ [1, "asc"], [2, "asc"] ]);
	    	   //table.order([ [0, "asc"], [1, "asc"] ]);
	       });
	    });
    </script>

</body>
</html>